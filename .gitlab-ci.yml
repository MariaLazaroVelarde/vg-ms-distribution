# =============================================================================
# GitLab CI/CD Pipeline - MS-DISTRIBUTION
# Construye y sube imagen Docker a DockerHub
# =============================================================================

stages:
     - build
     - docker-build

variables:
     DOCKER_IMAGE_NAME: "isaelfatamadev/jass-ms-distribution"
     DOCKER_TAG: "latest"
     DOCKER_TAG_VERSION: "2.0.0"
     DOCKER_TAG_SIZE: "250mib"
     MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

# Cache para optimizar builds
cache:
     paths:
          - .m2/repository/
          - target/

# =============================================================================
# STAGE 1: Build & Test
# =============================================================================
maven-build:
     stage: build
     image: maven:3.9.6-eclipse-temurin-21-alpine
     script:
          - echo "üöÄ Iniciando build del MS-Distribution..."
          - mvn --version
          - java -version
          - echo "üì¶ Descargando dependencias..."
          - mvn dependency:resolve -B -q
          - echo "üî® Compilando proyecto..."
          - mvn clean compile -B -q
          - echo "üß™ Ejecutando tests..."
          - mvn test -B || echo "‚ö†Ô∏è Tests fallaron pero continuamos..."
          - echo "üìã Generando JAR..."
          - mvn package -DskipTests -B -q
          - ls -la target/
          - echo "‚úÖ Build completado exitosamente"
     artifacts:
          paths:
               - target/*.jar
          expire_in: 1 hour
     only:
          - main
          - develop
          - merge_requests

# =============================================================================
# STAGE 2: Docker Build & Push
# =============================================================================
docker-build-push:
     stage: docker-build
     image: docker:24.0.5
     services:
          - docker:24.0.5-dind
     variables:
          DOCKER_DRIVER: overlay2
          DOCKER_TLS_CERTDIR: "/certs"
     before_script:
          - echo "üê≥ Configurando Docker..."
          - docker info
          - echo "üîë Autenticando con DockerHub..."
          - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
     script:
          - echo "üèóÔ∏è Construyendo imagen Docker..."
          - docker build -t $DOCKER_IMAGE_NAME:$DOCKER_TAG .
          - docker tag $DOCKER_IMAGE_NAME:$DOCKER_TAG $DOCKER_IMAGE_NAME:$DOCKER_TAG_VERSION
          - docker tag $DOCKER_IMAGE_NAME:$DOCKER_TAG $DOCKER_IMAGE_NAME:$DOCKER_TAG_SIZE
          - docker tag $DOCKER_IMAGE_NAME:$DOCKER_TAG $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA
          - echo "üìä Verificando tama√±o de imagen..."
          - docker images $DOCKER_IMAGE_NAME
          - echo "üì§ Subiendo im√°genes a DockerHub..."
          - docker push $DOCKER_IMAGE_NAME:$DOCKER_TAG
          - docker push $DOCKER_IMAGE_NAME:$DOCKER_TAG_VERSION
          - docker push $DOCKER_IMAGE_NAME:$DOCKER_TAG_SIZE
          - docker push $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA
          - echo "‚úÖ Im√°genes subidas exitosamente:"
          - echo "   - $DOCKER_IMAGE_NAME:$DOCKER_TAG"
          - echo "   - $DOCKER_IMAGE_NAME:$DOCKER_TAG_VERSION"
          - echo "   - $DOCKER_IMAGE_NAME:$DOCKER_TAG_SIZE"
          - echo "   - $DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
     after_script:
          - docker logout
     dependencies:
          - maven-build
     only:
          - main
          - develop
